#!/usr/bin/perl

use strict;
use warnings;
use Getopt::Long;
use Pod::Usage;
use Data::Dumper    qw/Dumper/;
use English         qw/ -no_match_vars /;
use FindBin         qw/$Bin/;
use Term::ANSIColor qw/colored/;

our $VERSION = 0.001;
my ($name) = $PROGRAM_NAME =~ m{^.*/(.*?)$}mxs;

my %option = (
    colour_char => 1,
    verbose     => 0,
    man         => 0,
    help        => 0,
    VERSION     => 0,
);

main();
exit 0;

sub main {
    Getopt::Long::Configure('bundling');
    GetOptions(
        \%option,                      'line|n=i',
        'blame|b',                     'column|c=i',
        'position|p=i',                'before|BEFORE|B=i',
        'after|AFTER|A=i',             'context|CONTEXT|C=i',
        'colour_char|colour-char|P=i', 'line_no|lines|l',
        'ends|e',                      'quiet|silent|q',
        'verbose|v+',                  'man',
        'help',                        'VERSION!',
    ) or pod2usage(2);

    if ( $option{'VERSION'} ) {
        print "$name Version = $VERSION\n";
        exit 1;
    }
    elsif ( $option{'man'} ) {
        pod2usage( -verbose => 2 );
    }
    elsif ( $option{'help'} ) {
        pod2usage( -verbose => 1 );
    }

    if (!$option{remote}) {
        $option{remote} = pop @ARGV;
    }

    my @local = get_files('HEAD');
    my %local = map {chomp;  $_ => 1 } get_files('HEAD');
    my %remote = map { chomp; $_ => 1 } get_files($option{remote});
    my %all = (%local, %remote);
    my @all = sort keys %all;
    warn Dumper \%all;
    warn join "\n", @all;

    for my $file (@all) {
        if (!$local{$file}) {
            warn "$file missing locally\n";
        }
        if (!$remote{$file}) {
            warn "$file missing remotely\n";
        }
    }
}

sub get_files {
    my ($ref) = @_;
    warn "git ls-tree --full-tree -r --name-only $ref\n";
    return `git ls-tree --full-tree -r --name-only $ref`;
}
